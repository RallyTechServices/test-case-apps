<!DOCTYPE html>
<html>
<head>
    <title>Test Status by Attribute</title>
    <!--  (c) 2017 CA Technologies.  All Rights Reserved. -->
    <!--  Build Date: Mon Sep 18 2017 13:21:26 GMT-0600 (MDT) -->
    
    <script type="text/javascript">
        var APP_BUILD_DATE = "Mon Sep 18 2017 13:21:26 GMT-0600 (MDT)";
        var STORY    = "US1716";
        var BUILDER  = "corkr03";
        var CHECKSUM = 16250461957;
    </script>
    
    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>
    <!-- our highcharts (needed so that we can add patterns) 
    <script type="text/javascript" src="/apps/2.1/lib/analytics/analytics-all.js"></script>
    -->
    
    
    <script type="text/javascript">
        Rally.onReady(function() {
            Ext.define("Rally.technicalservices.InfoLink",{extend:"Rally.ui.dialog.Dialog",alias:"widget.tsinfolink",informationHtml:null,title:"Build Information",defaults:{padding:5,margin:5},closable:!0,draggable:!0,autoShow:!0,width:350,informationalConfig:null,items:[{xtype:"container",itemId:"information"}],initComponent:function(){Ext.id(this);this.title="<span class='icon-help'> </span>"+this.title,this.callParent(arguments)},_generateChecksum:function(a){var b,c=305419896;for(a=a.replace(/var CHECKSUM = .*;/,""),a=a.replace(/var BUILDER  = .*;/,""),a=a.replace(/\s/g,""),b=0;b<a.length;b++)c+=a.charCodeAt(b)*b;return c},_checkChecksum:function(a){var b=Ext.create("Deft.Deferred"),c=this;return Ext.Ajax.request({url:document.URL,params:{id:1},success:function(a){if(text=a.responseText,CHECKSUM){var d=c._generateChecksum(text);if(CHECKSUM!==d)return void b.resolve(!1)}b.resolve(!0)}}),b.promise},_addToContainer:function(a){var b=Ext.apply({xtype:"container",height:200,overflowY:!0},this.informationalConfig);a.add(b)},afterRender:function(){var a=Rally.getApp();if(!Ext.isEmpty(this.informationalConfig)){var b=this.down("#information");this._addToContainer(b)}a.isExternal()?this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:"... Running externally"}):this._checkChecksum(a).then({scope:this,success:function(a){a||this.addDocked({xtype:"container",cls:"build-info",dock:"bottom",padding:2,html:'<span class="icon-warning"> </span>Checksums do not match'})},failure:function(a){console.log("oops:",a)}}),this.callParent(arguments)},beforeRender:function(){if(this.callParent(arguments),this.informationHtml&&this.addDocked({xtype:"component",componentCls:"intro-panel",padding:2,html:this.informationHtml,doc:"top"}),this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:"This app was created by the CA AC Technical Services Team."}),APP_BUILD_DATE){var a=Ext.String.format("Built on: {0} <br/>Built by: {1}",APP_BUILD_DATE,BUILDER);STORY&&(a=a+"<br/>Source story: "+STORY),this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:a})}}}),Ext.define("Rally.technicalservices.Logger",{constructor:function(a){Ext.apply(this,a)},log:function(a){var b="[ "+Ext.util.Format.date(new Date,"Y-m-d H:i:s.u")+" ]",c=[];c=Ext.Array.push(c,[b]),c=Ext.Array.push(c,Ext.Array.slice(arguments,0)),window.console&&console.log.apply(console,c)}}),Ext.define("Rally.technicalservices.WsapiToolbox",{singleton:!0,fetchWsapiCount:function(a,b){var c=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:a,fetch:["ObjectID"],filters:b,limit:1,pageSize:1}).load({callback:function(d,e,f){f?c.resolve(e.resultSet.totalRecords):c.reject(Ext.String.format("Error getting {0} count for {1}: {2}",a,b.toString(),e.error.errors.join(",")))}}),c},fetchWsapiRecords:function(a){var b=Ext.create("Deft.Deferred");a.limit||(a.limit="Infinity"),a.pageSize||(a.pageSize=2e3);Ext.create("Rally.data.wsapi.Store",a).load({callback:function(a,c,d){d?b.resolve(a):b.reject(Ext.String.format("Error getting {0} for {1}: {2}",model,query_filters.toString(),c.error.errors.join(",")))}});return b},fetchArtifacts:function(a){var b=Ext.create("Deft.Deferred");a.limit||(a.limit="Infinity"),a.pageSize||(a.pageSize=2e3);Ext.create("Rally.data.wsapi.artifact.Store",a).load({callback:function(a,c,d){d?b.resolve(a):b.reject(Ext.String.format("Error getting {0} for {1}: {2}",model,query_filters.toString(),c.error.errors.join(",")))}});return b},fetchReleases:function(a){var b=Ext.create("Deft.Deferred"),c=a.getRecord();return null==c&&b.resolve([]),Ext.create("Rally.data.wsapi.Store",{model:"Release",fetch:["ObjectID"],filters:[{property:"Name",value:c.get("Name")},{property:"ReleaseStartDate",value:c.get("ReleaseStartDate")},{property:"ReleaseDate",value:c.get("ReleaseDate")}],limit:1/0}).load({callback:function(a,c,d){d?b.resolve(a):b.reject("Error loading Releases: "+c.error.errors.join(","))}}),b},fetchAllowedValues:function(a,b){var c=Ext.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:a,success:function(a){a.getField(b).getAllowedValueStore().load({callback:function(a,b,d){var e=Ext.Array.map(a,function(a){return a.get("StringValue")});c.resolve(e)}})},failure:function(a){c.reject("Error loading field values: "+a)}}),c},fetchModelFields:function(a,b){var c=Ext.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:a,success:function(a){var d=a.getFields();return Ext.isEmpty(b)?void c.resolve(d):(d=Ext.Array.filter(d,function(a){return!Ext.Array.contains(b,a.name)}),void c.resolve(d))},failure:function(a){c.reject("Error loading field values: "+a)}}),c},saveCSVToFile:function(a,b,c){void 0===c&&(c={type:"text/csv;charset=utf-8"}),this.saveAs(a,b,c)},saveAs:function(a,b){if(Ext.isIE9m)return void Rally.ui.notify.Notifier.showWarning({message:"Export is not supported for IE9 and below."});var c=null;try{c=new Blob([a],{type:"text/plain"})}catch(d){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,window.BlobBuilder&&"TypeError"==d.name&&(bb=new BlobBuilder,bb.append([a]),c=bb.getBlob("text/plain"))}if(!c)return void Rally.ui.notify.Notifier.showWarning({message:"Export is not supported for this browser."});var e=b;if(Ext.isIE10p)return void window.navigator.msSaveOrOpenBlob(c,e);var f=this.createObjectURL(c);if(f){var g=document.createElement("a");"download"in g?g.download=e:g.target="_blank",g.innerHTML="Download File",g.href=f,Ext.isChrome||(g.onclick=this.destroyClickedElement,g.style.display="none",document.body.appendChild(g)),g.click()}else Rally.ui.notify.Notifier.showError({message:"Export is not supported "})},createObjectURL:function(a){return window.webkitURL?window.webkitURL.createObjectURL(a):window.URL&&window.URL.createObjectURL?window.URL.createObjectURL(a):null},destroyClickedElement:function(a){document.body.removeChild(a.target)}}),Ext.define("test-status-by-attribute",{extend:"Rally.app.App",componentCls:"app",logger:new Rally.technicalservices.Logger,defaults:{margin:10},integrationHeaders:{name:"cats-test-status-by-attribute"},config:{defaultSettings:{modelName:"TestCase",xAxisField:"LastVerdict",yAxisField:"TestSet: Name",xAxisValues:void 0,yAxisValues:void 0,includeXTotal:!0,includeYTotal:!0,gridFilter:"",includeBlanks:!0,sortBy:"total",sortDir:"desc",rowLimit:""}},yAxisOptions:[],launch:function(){this._initializeApp()},onTimeboxScopeChange:function(a){this.logger.log("onTimeboxScopeChange",a),this.getContext().setTimeboxScope(a),this._updateDisplay()},_initializeApp:function(){fieldBlackList=["Milestones","Tags","Release","Iteration"],Deft.Promise.all([Rally.technicalservices.WsapiToolbox.fetchModelFields("TestSet",fieldBlackList),Rally.technicalservices.WsapiToolbox.fetchModelFields("Artifact",fieldBlackList),Rally.technicalservices.WsapiToolbox.fetchModelFields("TestCase",fieldBlackList),Rally.technicalservices.WsapiToolbox.fetchAllowedValues("TestCaseResult","Verdict")]).then({success:function(a){this._initializeYAxisOptions(a[0],a[1],a[2]),this.possibleVerdicts=a[3],this._initializeDisplay()},failure:this._showErrorNotification,scope:this})},_initializeYAxisOptions:function(a,b,c){var d=[];Ext.Array.each(c,function(a){var b=a.attributeDefinition;(b&&b.Constrained&&"COLLECTION"!=b.AttributeType||"TestFolder"===a.name)&&d.push({displayName:"TestCase: "+a.displayName,modelName:"TestCase",fieldName:a.name,queryName:a.name})}),Ext.Array.each(a,function(a){var b=a.attributeDefinition;(b&&b.Constrained&&"COLLECTION"!=b.AttributeType||"Name"===a.name)&&d.push({displayName:"TestSet: "+a.displayName,modelName:"TestSet",fieldName:a.name,queryName:"TestSets."+a.name})}),Ext.Array.each(b,function(a){var b=a.attributeDefinition;(b&&b.Constrained&&"COLLECTION"!=b.AttributeType||"Name"===a.name)&&d.push({displayName:"WorkProduct: "+a.displayName,modelName:"WorkProduct",fieldName:a.name,queryName:"WorkProduct."+a.name})}),this.logger.log("yAxisOptions",d),this.yAxisOptions=d},_showErrorNotification:function(a){Rally.ui.notify.Notifier.showError({message:a})},_initializeDisplay:function(){var a=this.add({xtype:"container",layout:"hbox",itemId:"selectorBox"});a.add({xtype:"rallycombobox",store:Ext.create("Ext.data.Store",{fields:["displayName","modelName","fieldName"],data:this.yAxisOptions}),itemId:"yAxisField",labelAlign:"right",margin:5,fieldLabel:"Group by",labelWidth:75,width:300,stateful:!0,stateId:this.getContext().getScopedStateId("groupBy"),displayField:"displayName",valueField:"displayName"}),a.add({xtype:"rallybutton",text:"Update",margin:5,listeners:{click:this._updateDisplay,scope:this}}),a.add({xtype:"container",flex:1}),a.add({xtype:"rallybutton",iconCls:"icon-export",margin:5,cls:"rly-small secondary",listeners:{click:this._export,scope:this}}),this.add({xtype:"container",itemId:"display_box"})},_export:function(){this.logger.log("_export");var a=this.down("rallygrid");if(a){var b=this.down("#yAxisField"),c=b.getValue(),d=this._getAxisModelName(b),e=this._getExportModelFieldNames(d),f=Ext.Array.map(e,function(a){return"name"===a?"Name":"test_case_count_executed"===a?"Executed Test Cases":"test_case_count_unexecuted"===a?"Unexecuted Test Cases":"test_case_count"===a?"Total Test Cases":a});this.logger.log("_export",e);var g=[];g.push(f.join(",")),a.getStore().each(function(a){var b=[];Ext.Array.each(e,function(c){b.push(a.get(c)||0)}),g.push(b.join(","))});var h=g.join("\r\n"),i=Ext.String.format("{0}-{1}.csv",c.replace(/[^a-zA-Z0-9]/g,"_"),Rally.util.DateTime.format(new Date,"Y-m-d-h-i-s"));Rally.technicalservices.WsapiToolbox.saveCSVToFile(h,i)}},_fetchTimeboxData:function(a,b){this.logger.log("_fetchTimeboxData",a,b,this.getContext().getTimeboxScope());var c=Ext.create("Deft.Deferred");if(this.records_in_timebox=null,this.getContext().getTimeboxScope()){this.getContext().getTimeboxScope();this.logger.log("timeboxScope",this.getContext().getTimeboxScope().getQueryFilter());var d=["TestSet","HierarchicalRequirement","Defect"];"TestSet"==b&&(d=[b]),"WorkProduct"==b&&(d=["HierarchicalRequirement","Defect"]),Rally.technicalservices.WsapiToolbox.fetchArtifacts({models:d,fetch:["ObjectID","TestCaseCount","TestCases","LastVerdict",a],filters:this.getContext().getTimeboxScope().getQueryFilter()}).then({success:function(a){c.resolve(a)},failure:function(a){c.reject(a)}})}else c.resolve(null);return c.promise},_updateDisplay:function(){var a=this,b=this.down("#yAxisField");if(!Ext.isEmpty(b.getValue())){var c=this._getAxisModelName(b),d=this._getAxisFieldName(b);this.setLoading(),Deft.Chain.pipeline([function(){return a._fetchTimeboxData(d,c)},function(b){return a._fetchData(c,d,b)},function(b){return a._organizeTestCaseResults(c,d,b)},function(b){return a._addSummaryColumn(b)},function(b){return a._removeEmptyRows(b)},function(b){return a._buildGrid(b,c)}],this).then({failure:this._showErrorNotification,success:null,scope:this}).always(function(){a.setLoading(!1)})}},_getAxisModelName:function(a){var b=a.getValue(),c=a.getStore().findRecord("displayName",b);return c&&c.get("modelName")},_getAxisFieldName:function(a){var b=a.getValue(),c=a.getStore().findRecord("displayName",b);return c&&c.get("fieldName")},_getTestCaseResultFilters:function(a,b,c){this.logger.log("_getTestCaseResultFilters",a,b,c);var d=[];return c?(Ext.Array.each(c,function(a){if(a.get("TestCaseCount")>0){var b="TestCase.WorkProduct.ObjectID";"testset"===a.get("_type")&&(b="TestSet.ObjectID"),d.push({property:b,value:a.get("ObjectID")})}}),d.length>1&&(d=Rally.data.wsapi.Filter.or(d)),0===d.length&&(d=[{property:"ObjectID",value:0}])):"Artifact"===a?d.push({property:"TestCase.WorkProduct.ObjectID",operator:">",value:0}):"TestSet"===a?d.push({property:"TestSet.ObjectID",operator:">",value:0}):d=[{property:"ObjectID",operator:">",value:0}],d},_fetchData:function(a,b,c){return this.logger.log("_updateDisplay",a,b),this.records_in_timebox=c,Rally.technicalservices.WsapiToolbox.fetchWsapiRecords({model:"TestCaseResult",fetch:["TestCase","Verdict","TestSet","WorkProduct","ObjectID","Name","Date",b],enablePostGet:!0,filters:this._getTestCaseResultFilters(a,b,c),sorters:[{property:"Date",direction:"ASC"}]})},_organizeTestCaseResults:function(a,b,c){this.logger.log("Organize Results",c.length);var d={};Ext.Array.each(c,function(b){var c=b.get("TestCase")&&b.get("TestCase").ObjectID,e=b.get(a)&&b.get(a).ObjectID||"None";"WorkProduct"===a&&(e=b.get("TestCase")[a]&&b.get("TestCase")[a].ObjectID||"None"),Ext.isEmpty(d[c])&&(d[c]={}),d[c][e]=b});var e={};return Ext.isEmpty(this.records_in_timebox)||Ext.Array.each(this.records_in_timebox,function(c){var d=c.get("_type");if(("hierarchicalrequirement"==d.toLowerCase()||"defect"==d.toLowerCase())&&(d="WorkProduct"),d.toLowerCase()==a.toLowerCase()){var f=c.get(b);f._refObjectName&&(f=f._refObjectName),Ext.isEmpty(e[f])&&(e[f]={name:f,test_case_count:0});var g=c.get("TestCaseCount");e[f].test_case_count=e[f].test_case_count+g}else{var f="None";Ext.isEmpty(e[f])&&(e[f]={name:f,test_case_count:0})}}),Ext.Object.each(d,function(c,d){Ext.Object.each(d,function(c,d){var f=this._getValueFromRelatedRecord(d,a,b),g=d.get("Verdict");Ext.isEmpty(e[f])&&(e[f]={name:f}),Ext.isEmpty(e[f][g])&&(e[f][g]=0),e[f][g]=e[f][g]+1},this)},this),e},_addSummaryColumn:function(a){return verdict_columns=this.possibleVerdicts,Ext.Object.each(a,function(a,b){var c=0;Ext.Array.each(verdict_columns,function(a){var d=b[a]||0;c+=d}),b.test_case_count_executed=c,Ext.isNumber(b.test_case_count)?(b.test_case_count<b.test_case_count_executed&&(b.test_case_count=b.test_case_count_executed),b.test_case_count_unexecuted=b.test_case_count-b.test_case_count_executed,b.Total=b.test_case_count):b.Total=c}),a},_removeEmptyRows:function(a){var b={};return Ext.Object.each(a,function(a,c){c.Total>0&&(b[a]=c)}),b},_getValueFromRelatedRecord:function(a,b,c){var d="";return d="TestCase"==b||"TestSet"==b?a.get(b)&&a.get(b)[c]||"None":a.get("TestCase")[b]&&a.get("TestCase")[b][c]||"None",d._refObjectName&&(d=d._refObjectName),d},_buildGrid:function(a,b){this.logger.log("_buildGrid",a,b);var c=this._getXValuesFromCounts(a,b),d=Ext.Object.getValues(a);this.logger.log("cols",c),this.logger.log("rows",d);var e=Ext.create("Rally.data.custom.Store",{fields:this._getModelFieldNames(b),data:d,pageSize:d.length}),f=this.down("#display_box");return f.removeAll(),0===d.length?void f.add({xtype:"container",padding:100,margin:50,html:"No Data Found"}):void f.add({xtype:"rallygrid",store:e,showRowActionsColumn:!1,showPagingToolbar:!1,columnCfgs:this._getColumns(c),features:[{ftype:"summary"}]})},_getColumns:function(a){var b=Ext.Array.map(a,function(a){return"name"==a?{dataIndex:a,text:"",flex:1,summaryRenderer:function(a,b,c){return"<div class='summary'>Total</div>"}}:"test_case_count_executed"==a?{dataIndex:a,text:"",renderer:function(a,b,c){return Ext.create("Rally.ui.renderer.template.progressbar.ProgressBarTemplate",{shouldShowPercentDone:function(a){return a.Total>0&&Ext.isNumber(a.test_case_count_executed)&&Ext.isNumber(a.test_case_count_unexecuted)},calculatePercent:function(a){return Math.round(100*(a.test_case_count_executed||0)/a.Total)},calculateColorFn:function(a){return Rally.util.Colors.blue_lt}}).apply(c.getData())},summaryType:function(b){var c=0;return Ext.Array.each(b,function(b){var d=b.get(a)||0;c+=d}),c},summaryRenderer:function(a,b,c){return Ext.create("Rally.ui.renderer.template.progressbar.ProgressBarTemplate",{shouldShowPercentDone:function(a){return a.Total>0},calculatePercent:function(b){return Math.round(100*(a||0)/b.Total)},calculateColorFn:function(a){return Rally.util.Colors.blue_lt}}).apply(b.record.getData())}}:"test_case_count_unexecuted"==a?{dataIndex:a,text:"Unexecuted",summaryType:function(b){var c=0;return Ext.Array.each(b,function(b){var d=b.get(a)||0;c+=d}),c},align:"center",renderer:function(a,b,c){b.tdCls="non-summary";var d=c&&c.get("Total");return d>0?Ext.String.format("{0}<br/>{1}%",a,Math.round(100*a/d)):Ext.String.format("{0}<br/>N/A",a||0)},summaryRenderer:function(a,b,c){var d=b.record&&b.record.get("Total");return d>0?Ext.String.format("<div class='summary'>{0}<br/>{1}%</div>",a,Math.round(100*a/d)):Ext.String.format("<div class='summary'>{0}</div>",a||0)}}:{dataIndex:a,text:a,summaryType:function(b){var c=0;return Ext.Array.each(b,function(b){var d=b.get(a)||0;c+=d}),c},align:"center",cls:"non-summary",renderer:function(a,b,c){var d=c&&c.get("Total");return d>0?Ext.String.format("{0}<br/>{1}%",a||0,Math.round(100*a/d)):Ext.String.format("{0}<br/>N/A%",a||0)},summaryRenderer:function(a,b,c){var d=b.record&&b.record.get("Total");return d>0?Ext.String.format("<div class='summary'>{0}<br/>{1}%</div>",a,Math.round(100*a/d)):Ext.String.format("<div class='summary'>{0}</div>",a||0)}}});return b},_getModelFieldNames:function(a){var b=["name","test_case_count_executed","test_case_count"];return b=b.concat(this.possibleVerdicts).concat("Total"),"TestCase"!=a&&b.push("test_case_count_unexecuted"),Ext.Array.unique(b)},_getExportModelFieldNames:function(a){var b=["name","test_case_count_executed"];return b=b.concat(this.possibleVerdicts),"TestCase"!=a&&b.push("test_case_count_unexecuted"),b.push("test_case_count"),Ext.Array.unique(b)},_getXValuesFromCounts:function(a,b){var c=["name","test_case_count_executed"];return c=c.concat(this.possibleVerdicts),"TestCase"!=b&&c.push("test_case_count_unexecuted"),c.push("Total"),Ext.Array.unique(c)},getOptions:function(){return[{text:"About...",handler:this._launchInfo,scope:this}]},_launchInfo:function(){this.about_dialog&&this.about_dialog.destroy(),this.about_dialog=Ext.create("Rally.technicalservices.InfoLink",{})},isExternal:function(){return"undefined"==typeof this.getAppId()}});
            
               Rally.launchApp('test-status-by-attribute', {
                   name: 'Test Status by Attribute'
               });
        });
    </script>
    
    <style type="text/css">

.app {
}
.tsinfolink {
    position:absolute;
    right:0px;
    width: 14px;
    height: 14px;
    border-radius: 7px;
    text-align: center;
    color: white;
    background: #C0C0C0;
    border-style: solid;
    border-width: 1px;
    margin-top: 25px;
    margin-right: 5px;
    cursor: pointer;
}

.x-grid-cell-inner {
    padding: 4px 2px;
}

.summary {
  font-family: ProximaNovaBold;
  text-transform: uppercase;
}
.non-summary {
  font-family: ProximaNova;
}

    </style>

</head>
<body></body>
</html>