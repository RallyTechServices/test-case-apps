<!DOCTYPE html>
<html>
<head>
    <title>Test Status by Attribute</title>
    <!--  (c) 2017 CA Technologies.  All Rights Reserved. -->
    <!--  Build Date: Fri Aug 25 2017 10:37:27 GMT-0700 (PDT) -->
    
    <script type="text/javascript">
        var APP_BUILD_DATE = "Fri Aug 25 2017 10:37:27 GMT-0700 (PDT)";
        var STORY    = "US1716";
        var BUILDER  = "marjo60";
        var CHECKSUM = 5396717728;
    </script>
    
    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>
    <!-- our highcharts (needed so that we can add patterns) 
    <script type="text/javascript" src="/apps/2.1/lib/analytics/analytics-all.js"></script>
    -->
    
    
    <script type="text/javascript">
        Rally.onReady(function() {
            Ext.define("Rally.technicalservices.InfoLink",{extend:"Rally.ui.dialog.Dialog",alias:"widget.tsinfolink",informationHtml:null,title:"Build Information",defaults:{padding:5,margin:5},closable:!0,draggable:!0,autoShow:!0,width:350,informationalConfig:null,items:[{xtype:"container",itemId:"information"}],initComponent:function(){Ext.id(this);this.title="<span class='icon-help'> </span>"+this.title,this.callParent(arguments)},_generateChecksum:function(a){var b,c=305419896;for(a=a.replace(/var CHECKSUM = .*;/,""),a=a.replace(/var BUILDER  = .*;/,""),a=a.replace(/\s/g,""),b=0;b<a.length;b++)c+=a.charCodeAt(b)*b;return c},_checkChecksum:function(a){var b=Ext.create("Deft.Deferred"),c=this;return Ext.Ajax.request({url:document.URL,params:{id:1},success:function(a){if(text=a.responseText,CHECKSUM){var d=c._generateChecksum(text);if(CHECKSUM!==d)return void b.resolve(!1)}b.resolve(!0)}}),b.promise},_addToContainer:function(a){var b=Ext.apply({xtype:"container",height:200,overflowY:!0},this.informationalConfig);a.add(b)},afterRender:function(){var a=Rally.getApp();if(!Ext.isEmpty(this.informationalConfig)){var b=this.down("#information");this._addToContainer(b)}a.isExternal()?this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:"... Running externally"}):this._checkChecksum(a).then({scope:this,success:function(a){a||this.addDocked({xtype:"container",cls:"build-info",dock:"bottom",padding:2,html:'<span class="icon-warning"> </span>Checksums do not match'})},failure:function(a){console.log("oops:",a)}}),this.callParent(arguments)},beforeRender:function(){if(this.callParent(arguments),this.informationHtml&&this.addDocked({xtype:"component",componentCls:"intro-panel",padding:2,html:this.informationHtml,doc:"top"}),this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:"This app was created by the CA AC Technical Services Team."}),APP_BUILD_DATE){var a=Ext.String.format("Built on: {0} <br/>Built by: {1}",APP_BUILD_DATE,BUILDER);STORY&&(a=a+"<br/>Source story: "+STORY),this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:a})}}}),Ext.define("Rally.technicalservices.Logger",{constructor:function(a){Ext.apply(this,a)},log:function(a){var b="[ "+Ext.util.Format.date(new Date,"Y-m-d H:i:s.u")+" ]",c=[];c=Ext.Array.push(c,[b]),c=Ext.Array.push(c,Ext.Array.slice(arguments,0)),window.console&&console.log.apply(console,c)}}),Ext.define("Rally.technicalservices.WsapiToolbox",{singleton:!0,fetchWsapiCount:function(a,b){var c=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:a,fetch:["ObjectID"],filters:b,limit:1,pageSize:1}).load({callback:function(d,e,f){f?c.resolve(e.resultSet.totalRecords):c.reject(Ext.String.format("Error getting {0} count for {1}: {2}",a,b.toString(),e.error.errors.join(",")))}}),c},fetchWsapiRecords:function(a){var b=Ext.create("Deft.Deferred");a.limit||(a.limit="Infinity"),a.pageSize||(a.pageSize=2e3);Ext.create("Rally.data.wsapi.Store",a).load({callback:function(a,c,d){d?b.resolve(a):b.reject(Ext.String.format("Error getting {0} for {1}: {2}",model,query_filters.toString(),c.error.errors.join(",")))}});return b},fetchReleases:function(a){var b=Ext.create("Deft.Deferred"),c=a.getRecord();return null==c&&b.resolve([]),Ext.create("Rally.data.wsapi.Store",{model:"Release",fetch:["ObjectID"],filters:[{property:"Name",value:c.get("Name")},{property:"ReleaseStartDate",value:c.get("ReleaseStartDate")},{property:"ReleaseDate",value:c.get("ReleaseDate")}],limit:1/0}).load({callback:function(a,c,d){d?b.resolve(a):b.reject("Error loading Releases: "+c.error.errors.join(","))}}),b},fetchAllowedValues:function(a,b){var c=Ext.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:a,success:function(a){a.getField(b).getAllowedValueStore().load({callback:function(a,b,d){var e=Ext.Array.map(a,function(a){return a.get("StringValue")});c.resolve(e)}})},failure:function(a){c.reject("Error loading field values: "+a)}}),c},fetchModelFields:function(a,b){var c=Ext.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:a,success:function(a){var d=a.getFields();return Ext.isEmpty(b)?void c.resolve(d):(d=Ext.Array.filter(d,function(a){return!Ext.Array.contains(b,a.name)}),void c.resolve(d))},failure:function(a){c.reject("Error loading field values: "+a)}}),c}}),Ext.define("test-status-by-attribute",{extend:"Rally.app.App",componentCls:"app",logger:new Rally.technicalservices.Logger,defaults:{margin:10},integrationHeaders:{name:"cats-test-status-by-attribute"},config:{defaultSettings:{modelName:"TestCase",xAxisField:"LastVerdict",yAxisField:"TestSet: Name",xAxisValues:void 0,yAxisValues:void 0,includeXTotal:!0,includeYTotal:!0,gridFilter:"",includeBlanks:!0,sortBy:"total",sortDir:"desc",rowLimit:""}},yAxisOptions:[],launch:function(){this._initializeApp()},_initializeApp:function(){fieldBlackList=["Milestones","Tags"],Deft.Promise.all([Rally.technicalservices.WsapiToolbox.fetchModelFields("TestSet",fieldBlackList),Rally.technicalservices.WsapiToolbox.fetchModelFields("Artifact",fieldBlackList),Rally.technicalservices.WsapiToolbox.fetchModelFields("TestCase",fieldBlackList)]).then({success:function(a){this._initializeYAxisOptions(a[0],a[1],a[2]),this._initializeDisplay()},failure:this._showErrorNotification,scope:this})},_initializeYAxisOptions:function(a,b,c){var d=[];Ext.Array.each(c,function(a){var b=a.attributeDefinition;(b&&b.Constrained&&"COLLECTION"!=b.AttributeType||"TestFolder"===a.name)&&d.push({displayName:"TestCase: "+a.displayName,modelName:"TestCase",fieldName:a.name,queryName:a.name})}),Ext.Array.each(a,function(a){var b=a.attributeDefinition;(b&&b.Constrained&&"COLLECTION"!=b.AttributeType||"Name"===a.name)&&d.push({displayName:"TestSet: "+a.displayName,modelName:"TestSet",fieldName:a.name,queryName:"TestSets."+a.name})}),Ext.Array.each(b,function(a){var b=a.attributeDefinition;(b&&b.Constrained&&"COLLECTION"!=b.AttributeType||"Name"===a.name)&&d.push({displayName:"WorkProduct: "+a.displayName,modelName:"WorkProduct",fieldName:a.name,queryName:"WorkProduct."+a.name})}),this.logger.log("yAxisOptions",d),this.yAxisOptions=d},_showErrorNotification:function(a){Rally.ui.notify.Notifier.showError({message:a})},_initializeDisplay:function(){var a=this.add({xtype:"container",layout:"hbox",itemId:"selectorBox"});a.add({xtype:"rallycombobox",store:Ext.create("Ext.data.Store",{fields:["displayName","modelName","fieldName"],data:this.yAxisOptions}),itemId:"yAxisField",labelAlign:"right",margin:5,fieldLabel:"Y Axis Field",labelWidth:100,displayField:"displayName",valueField:"displayName"}),a.add({xtype:"rallybutton",text:"Update",margin:5,listeners:{click:this._updateDisplay,scope:this}}),this.add({xtype:"container",itemId:"display_box"})},_updateDisplay:function(){var a=this,b=this.down("#yAxisField");if(!Ext.isEmpty(b.getValue())){var c=this._getAxisModelName(b),d=this._getAxisFieldName(b);this.setLoading(),Deft.Chain.pipeline([function(){return a._fetchData(c,d)},function(b){return a._organizeTestCaseResults(c,d,b)},function(b){return a._buildGrid(b)}],this).then({failure:this._showErrorNotification,success:null,scope:this}).always(function(){a.setLoading(!1)})}},_getAxisModelName:function(a){var b=a.getValue(),c=a.getStore().findRecord("displayName",b);return c&&c.get("modelName")},_getAxisFieldName:function(a){var b=a.getValue(),c=a.getStore().findRecord("displayName",b);return c&&c.get("fieldName")},_getFilters:function(a,b){return[{property:"ObjectID",operator:">",value:0}]},_fetchData:function(a,b){return this.logger.log("_updateDisplay",a,b),Rally.technicalservices.WsapiToolbox.fetchWsapiRecords({model:"TestCaseResult",fetch:["TestCase","Verdict","TestSet","WorkProduct","ObjectID","Name","Date",b],limit:1/0,pageSize:2e3,filters:this._getFilters(),sorters:[{property:"Date",direction:"ASC"}]})},_organizeTestCaseResults:function(a,b,c){this.logger.log("Organize Results",c.length);var d={};Ext.Array.each(c,function(b){var c=b.get("TestCase")&&b.get("TestCase").ObjectID,e=b.get(a)&&b.get(a).ObjectID||"None";"WorkProduct"===a&&(e=b.get("TestCase")[a]&&b.get("TestCase")[a].ObjectID||"None"),Ext.isEmpty(d[c])&&(d[c]={}),d[c][e]=b}),this.logger.log(d);var e={};return Ext.Object.each(d,function(c,d){Ext.Object.each(d,function(c,d){value=this._getValueFromRelatedRecord(d,a,b),verdict=d.get("Verdict"),Ext.isEmpty(e[value])&&(e[value]={name:value}),Ext.isEmpty(e[value][verdict])&&(e[value][verdict]=0),e[value][verdict]=e[value][verdict]+1},this)},this),e},_getValueFromRelatedRecord:function(a,b,c){var d="";return d="TestCase"==b||"TestSet"==b?a.get(b)&&a.get(b)[c]||"None":a.get("TestCase")[b]&&a.get("TestCase")[b][c]||"None",d._refObjectName&&(d=d._refObjectName),d},_buildGrid:function(a){this.logger.log("_buildGrid",a);var b=this._getXValuesFromCounts(a),c=Ext.Object.getValues(a);this.logger.log("cols",b),this.logger.log("rows",c);var d=Ext.create("Rally.data.custom.Store",{fields:b,data:c});console.log(d);var e=this.down("#display_box");e.removeAll(),e.add({xtype:"rallygrid",store:d,showRowActionsColumn:!1,columnCfgs:this._getColumns(b)})},_getColumns:function(a){var b=Ext.Array.map(a,function(a){return"name"==a?{dataIndex:a,text:"",flex:1}:{dataIndex:a,text:a,renderer:function(a){return a||0}}});return b},_getXValuesFromCounts:function(a){var b=[];return Ext.Object.each(a,function(a,c){Ext.Array.push(b,Ext.Object.getKeys(c))}),Ext.Array.unique(b)},getOptions:function(){return[{text:"About...",handler:this._launchInfo,scope:this}]},_launchInfo:function(){this.about_dialog&&this.about_dialog.destroy(),this.about_dialog=Ext.create("Rally.technicalservices.InfoLink",{})},isExternal:function(){return"undefined"==typeof this.getAppId()}});
            
               Rally.launchApp('test-status-by-attribute', {
                   name: 'Test Status by Attribute'
               });
        });
    </script>
    
    <style type="text/css">

.app {
}
.tsinfolink {
    position:absolute;
    right:0px;
    width: 14px;
    height: 14px;
    border-radius: 7px;
    text-align: center;
    color: white;
    background: #C0C0C0;
    border-style: solid;
    border-width: 1px;
    margin-top: 25px;
    margin-right: 5px;
    cursor: pointer;
}
    </style>

</head>
<body></body>
</html>